{% extends 'task_manager/_base.html'%}
{% load static %}

{%block base_content%}


<!------------------------------------------------------------------------------------------------>
<!------------------------------ Table with running jobs------------------------------------------>
<!------------------------------------------------------------------------------------------------>

<div id="overview" class="panel-block">

    <table class="table is-bordered" id="runningJobsTable" style="margin-top: 1rem;">
        <tbody>

            <tr class="tableHead">
                <th>
                    <div class="th-center">Get into<br> Job Directory</div>
                </th>
                <th>
                    <div class="th-center">
                        <p>Get History</p>
                    </div>
                </th>
                <th>
                    <div class="th-center"> Kill the Job</div>
                </th>

                <th>
                    <div class="th-center">
                        <p>Job ID</p>
                    </div>
                </th>
                <th>
                    <div class="th-center">
                        <p>User</p>
                        <div class="select is-warning is-small">
                            <select id="userFilter" style="max-width: 4rem; border-color: lightgray;">
                                <option>All</option>
                            </select>
                        </div>
                    </div>
                </th>
                <th>
                    <div class="th-center">
                        <p> Name</p>
                    </div>
                </th>
                <th>
                    <div class="th-center">
                        <p>Program</p>
                        <div class="select is-warning is-small">
                            <select id="programFilter" style="max-width: 4rem; border-color: lightgray;">
                                <option>All</option>
                            </select>
                        </div>
                    </div>
                </th>

                <th>
                    <div class="th-center">
                        <p>Start time</p>
                    </div>
                </th>
                <th>
                    <div class="th-center">
                        <p>End time</p>
                    </div>
                </th>
                <th>

                    <div class="th-center">
                        <p>State</p>
                        <div class="select is-warning is-small">
                            <select id="stateFilter" style="max-width: 4rem; border-color: lightgray;">
                                <option>All</option>
                            </select>
                        </div>
                    </div>

                </th>
                <th>
                    <div class="th-center">
                        <p>Running time </p>
                    </div>
                </th>

                <th>
                    <div class="th-center">
                        <p>Used CPUs</p>
                    </div>
                </th>
                <th>
                    <div class="th-center">
                        <p> Used memory</p>
                    </div>
                </th>

            </tr>
            {% for entry in tasksData|slice:":5" %}
            <tr>
                <td>
                    <button class="button is-small table-button getDir" data-task-id="{{ entry.task.id }}">
                        Get dir.
                    </button>
                </td>
                <td>
                    <form method="post" action="{% url 'job_history' entry.task.pid %}" class="history-form">
                        {% csrf_token %}
                        <button class="getHis button is-small table-button"
                            data-url="{% url 'job_history' entry.task.pid %}">Get His</button>
                    </form>
                </td>
                <td>
                    {% if entry.task.state == "RUNNING" and entry.task.pid %}
                    <form method="post" action="{% url 'kill_job' entry.task.pid %}" class="kill-form">
                        {% csrf_token %}
                        <button type="button" class="button is-small table-button killJob"
                            data-pid="{{ entry.task.pid }}">
                            Kill
                        </button>
                    </form>
                    {% else %}
                    Not Available
                    {% endif %}
                </td>


                <td class="tableJobID">{{ entry.task.pid }}</td>
                <td class="tableUser">{{ entry.task.user }}</td>
                <td class="tableName">{{ entry.task.file_name }}</td>
                <td class="program">{{ entry.task.program }}</td>
                <td class="startTime">{{ entry.task.start_time|date:"d.m.Y H:i" }}</td>
                <td class="startTime">{{ entry.task.end_time|date:"d.m.Y H:i" }}</td>
                <td class="state">{{ entry.task.state }}</td>
                <td class="runningTime">{{ entry.running_time_str }}</td>
                <td class="cpus">{{ entry.cpu|floatformat:1 }}%</td>
                <td class="minMemory">{{ entry.memory }} MB</td>
            </tr>
            {% endfor %}

            {% for entry in tasksData|slice:"5:" %}
            <tr class="extra-row" style="display:none;">

                <td>
                    <button class="button is-small table-button getDir" data-task-id="{{ entry.task.id }}">
                        Get dir.
                    </button>
                </td>
                <td>
                    <form method="post" action="{% url 'job_history' entry.task.pid %}" class="history-form">
                        {% csrf_token %}
                        <button class="getHis button is-small table-button"
                            data-url="{% url 'job_history' entry.task.pid %}">Get His</button>
                    </form>
                </td>
                <td>
                    {% if entry.task.state == "RUNNING" and entry.task.pid %}
                    <form method="post" action="{% url 'kill_job' entry.task.pid %}" class="kill-form">
                        {% csrf_token %}
                        <button type="button" class="button is-small table-button killJob"
                            data-pid="{{ entry.task.pid }}">
                            Kill
                        </button>
                    </form>
                    {% else %}
                    Not Available
                    {% endif %}
                </td>


                <td class="tableJobID">{{ entry.task.pid }}</td>
                <td class="tableUser">{{ entry.task.user }}</td>
                <td class="tableName">{{ entry.task.file_name }}</td>
                <td class="program">{{ entry.task.program }}</td>
                <td class="startTime">{{ entry.task.start_time|date:"d.m.Y H:i" }}</td>
                <td class="startTime">{{ entry.task.end_time|date:"d.m.Y H:i" }}</td>
                <td class="state">{{ entry.task.state }}</td>
                <td class="runningTime">{{ entry.running_time_str }}</td>
                <td class="cpus">{{ entry.cpu|floatformat:1 }}%</td>
                <td class="minMemory">{{ entry.memory }} MB</td>
            </tr>
            {% endfor %}








        </tbody>
    </table>
    <button id="showMoreBtn" class="button is-warning is-info" style="margin-top: 0rem;">Show more</button>

    <script>
        const showMoreBtn = document.getElementById('showMoreBtn');
        let expanded = false;

        showMoreBtn.addEventListener('click', () => {
            const extraRows = document.querySelectorAll('.extra-row');
            expanded = !expanded;

            extraRows.forEach(row => {
                row.style.display = expanded ? '' : 'none';
            });

            showMoreBtn.textContent = expanded ? 'Show less' : 'Show more';
        });
    </script>

    <!--
    <nav class="pagination is-small" role="navigation" aria-label="pagination">
        <a href="#" class="pagination-previous">Previous</a>
        <a href="#" class="pagination-next">Next page</a>
        <ul class="pagination-list">
            {% for item in page_range %}
            <li><a href="{{request.path}}?page={{item}}" class="pagination-link" aria-label="Goto page 1">{item}</a>
            </li>
            {% endfor %}


        </ul>
    </nav>
-->
    <article class="message is-warning is-hidden info" id="killJobInfo">
        <div class="message-header">
            <p>Info</p>
        </div>
        <div class="message-body">
            <div id="killContent">

            </div>
            <div class="buttons" style="display: flex; justify-content: center;padding-top: 2rem; ">

                <button class="button is-warning" id="yesButton">YES</button>
                <button class="button is-warning" id="cancelButton">NO</button>
            </div>
        </div>
    </article>





    <div class="modal" id="historyModal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Task history</p>
                <button class="delete" aria-label="close" id="closeHistoryModal"></button>
            </header>

            <section class="modal-card-body">
                <canvas id="historyChart"></canvas>
            </section>

            <footer class="modal-card-foot">
                <button class="button is-warning" id="closeHistoryButton">Close</button>
            </footer>
        </div>
    </div>

    <script>
        const tableUsers = document.querySelectorAll(".tableUser");
        const userList = document.getElementById("userFilter")

        const tablePrograms = document.querySelectorAll(".program");
        const programList = document.getElementById("programFilter");

        const tableStates = document.querySelectorAll(".state");
        const stateList = document.getElementById("stateFilter");




        generateProgramList();

        //-------------------- Creation of program list ---------------//
        function generateProgramList() {
            let programsList = [];

            tablePrograms.forEach((el) => {
                if (!programsList.includes(el.textContent)) {
                    programsList.push(el.textContent);

                    const newListItem = document.createElement("option");
                    newListItem.textContent = el.textContent;
                    programList.appendChild(newListItem);
                }
            });
        }



        generateUserList()

        //-------------------- Creation of user list ---------------//
        function generateUserList() {
            usersList = [];
            tableUsers.forEach((el, index) => {
                if (!usersList.includes(el.textContent)) {
                    usersList[index] = el.textContent;
                    const newListItem = document.createElement("option");
                    newListItem.textContent = el.textContent;
                    userList.appendChild(newListItem);
                }
            })
        }

        //-------------------- Creation of state list ---------------//
        generateStateList();

        function generateStateList() {
            statesList = [];

            tableStates.forEach((el, index) => {
                if (!statesList.includes(el.textContent)) {
                    statesList[index] = el.textContent;
                    console.log(stateList)
                    const newListItem = document.createElement("option");
                    newListItem.textContent = el.textContent;
                    stateList.appendChild(newListItem);
                }
            })
        }
        const tableRows = document.querySelectorAll("#runningJobsTable tbody tr");
        //-------------------- Filter by user state and program ---------------//
        function filterTable() {
            const userValue = userList.value;
            const programValue = programList.value;
            const stateValue = stateList.value;

            for (let i = 1; i < tableRows.length; i++) {
                const userCell = tableRows[i].querySelector(".tableUser");
                const programCell = tableRows[i].querySelector(".program");
                const stateCell = tableRows[i].querySelector(".state");

                const user = userCell.textContent;
                const program = programCell.textContent;
                const state = stateCell.textContent;

                let visible = true;

                if (userValue !== 'All' && user !== userValue) {
                    visible = false;
                }

                if (programValue !== 'All' && program !== programValue) {
                    visible = false;
                }

                if (stateValue !== 'All' && state !== stateValue) {
                    visible = false;
                }

                tableRows[i].style.display = visible ? "" : "none";
            }
        }
        userFilter.addEventListener("change", filterTable);
        programFilter.addEventListener("change", filterTable);
        stateFilter.addEventListener("change", filterTable);



        //-------------------- Kill job ---------------//

        const killJobInfo = document.getElementById("killJobInfo");
        const killContent = document.getElementById("killContent");
        const yesButton = document.getElementById("yesButton");
        const cancelButton = document.getElementById("cancelButton");

        let currentKillForm = null;
        document.querySelectorAll(".killJob").forEach(btn => {
            btn.addEventListener("click", e => {
                e.preventDefault();

                const pid = btn.dataset.pid;
                currentKillForm = btn.closest("form");

                showKillWarning(pid);
            });
        });

        //-------------------- Kill Job  Warning---------------//
        function showKillWarning(pid) {
            killContent.innerHTML = '';
            killJobInfo.classList.remove("is-hidden");

            const msg = document.createElement("p");
            msg.textContent = `Do you really want to kill job with ID ${pid}?`;
            killContent.appendChild(msg);
        }

        // NO
        cancelButton.addEventListener("click", () => {
            killJobInfo.classList.add("is-hidden");
            killContent.innerHTML = '';
            currentKillForm = null;
        });

        // YES
        yesButton.addEventListener("click", () => {
            if (currentKillForm) {
                currentKillForm.submit();
            }
        });


        //-------------------- Get Dir. ---------------//
        const allGetDirButtons = document.querySelectorAll('.getDir');

        allGetDirButtons.forEach(btn => {
            btn.addEventListener("click", e => {
                const taskId = btn.dataset.taskId;
                getDir(taskId);
            });
        });

        function getDir(taskId) {
            window.location.href = `/tasks/open-dir/${taskId}/`;
        }

        //-------------------- Get His. ---------------//
        const historyModal = document.getElementById("historyModal");
        const closeHistoryModal = document.getElementById("closeHistoryModal");
        const closeHistoryButton = document.getElementById("closeHistoryButton");
        document.querySelector(".modal-background")
            .addEventListener("click", closeModal);

        let historyChartInstance = null;

        document.querySelectorAll('.getHis').forEach(button => {
            button.addEventListener('click', function (event) {
                event.preventDefault();  // Zabrání refreshi / submitu
                const url = this.dataset.url;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        historyModal.classList.add("is-active");

                        const ctx = document.getElementById('historyChart').getContext('2d');

                        if (historyChartInstance) {
                            historyChartInstance.destroy();
                        }

                        historyChartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.running_time,
                                datasets: [
                                    {
                                        label: 'Used CPU [%]',
                                        data: data.cpu,
                                        borderColor: 'red',
                                        fill: false,
                                        tension: 0.3,
                                        yAxisID: 'yCPU'   // <- přiřazení datasetu k ose CPU
                                    },
                                    {
                                        label: 'Used Memory [MB]',
                                        data: data.memory,
                                        borderColor: 'blue',
                                        fill: false,
                                        tension: 0.3,
                                        yAxisID: 'yMemory' // <- přiřazení datasetu k ose Memory
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'CPU & Memory vs Running Time',
                                        font: { size: 18, weight: 'bold' }
                                    }
                                },
                                scales: {
                                    x: {
                                        title: { display: true, text: 'Running Time [s]' }
                                    },
                                    yCPU: {  // první vertikální osa (vlevo)
                                        type: 'linear',
                                        position: 'left',
                                        title: { display: true, text: 'CPU [%]' },
                                        min: 0,
                                        max: 100
                                    },
                                    yMemory: {  // druhá vertikální osa (vpravo)
                                        type: 'linear',
                                        position: 'right',
                                        title: { display: true, text: 'Memory [MB]' },
                                        min: 0,
                                        // max si můžeš spočítat dynamicky podle dat, např. Math.max(...data.memory) + 50
                                    }
                                }
                            }
                        });
                    })
                    .catch(error => console.error("Fetch error:", error));
            });
        });
        // Zavření modalu
        function closeModal() {
            historyModal.classList.remove("is-active");

            if (historyChartInstance) {
                historyChartInstance.destroy();
                historyChartInstance = null;
            }
        }

        closeHistoryModal.addEventListener("click", closeModal);
        closeHistoryButton.addEventListener("click", closeModal);
    </script>




    <!------------------------------------------------------------------------------------------------>
    <!------------------------------      Charts  ---------------------------------------------------->
    <!------------------------------------------------------------------------------------------------>

    {{ cpu_labels|json_script:"cpu-labels-data" }}
    {{ used_cpus|json_script:"used-cpus-data" }}
    {{ memory_labels|json_script:"memory-labels-data" }}
    {{ used_memory|json_script:"used-memory-data" }}

    <div class="chartArea" style="margin-bottom: 1rem;">
        <div>
            <canvas id="memory_chart"></canvas>
        </div>
        <div>
            <canvas id="cpus_chart"></canvas>
        </div>


        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!--<script src="{% static 'task_manager/cpus_chart.js' %}"></script>
        <script src="{% static 'task_manager/memory_chart.js' %}"></script>-->

        <script>
            const memoryLabels = JSON.parse(
                document.getElementById("memory-labels-data").textContent
            );
            const usedMemory = JSON.parse(
                document.getElementById("used-memory-data").textContent
            );

            const cpuLabels = JSON.parse(
                document.getElementById("cpu-labels-data").textContent
            );
            const usedCpu = JSON.parse(
                document.getElementById("used-cpus-data").textContent
            );

            const MAX_MEMORY = 1000;
            //const restMemory = usedMemory.map(value => MAX_MEMORY - value);

            const memoryChart = document.getElementById("memory_chart");

            const memoryChartConfig = {
                type: 'bar',
                data: {
                    labels: memoryLabels,
                    datasets: [
                        {
                            label: 'Current used memory',
                            data: usedMemory,
                            backgroundColor: '#FFB70F',

                        },
                        // {
                        //     label: 'Remaining memory',
                        //     data: restMemory,
                        //     borderColor: ' rgba(54, 162, 235, 0.2)',
                        // },
                    ]
                },
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: 'Used memory [MB]',
                            font: { size: 18, weight: 'bold' }
                        },
                    },
                    responsive: true,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true }
                    }
                }
            };




            const MAX_CPU = 100;
            //const restCpu = usedCpu.map(value => MAX_CPU - value);

            const cpuChart = document.getElementById("cpus_chart");

            const cpuChartConfig = {
                type: 'bar',
                data: {
                    labels: cpuLabels,
                    datasets: [
                        {
                            label: 'Current used cpu',
                            data: usedCpu,
                            backgroundColor: '#FFB70F',

                        },
                        // {
                        //     label: 'Remaining cpu',
                        //      data: restCpu,
                        //      borderColor: ' rgba(54, 162, 235, 0.2)',
                        //  },
                    ]
                },
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: 'Used cpu [%]',
                            font: { size: 18, weight: 'bold' }
                        },
                    },
                    responsive: true,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true }
                    }
                }
            };

            new Chart(memoryChart, memoryChartConfig);
            new Chart(cpuChart, cpuChartConfig);
        </script>
    </div>
</div>

{%endblock%}